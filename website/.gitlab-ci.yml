website.build:
  stage: build
  dependencies: []
  rules:
    - changes:
        - website/**/*
  image: node:$NODE_VERSION
  script:
    - pushd website/
    - npm ci
    - npm run build
  cache:
      key: ${CI_COMMIT_REF_SLUG}
      policy: push
      paths:
        - .npm
        - website/node_modules/
        - website/.parcel-cache/
  artifacts:
      paths:
        - website/dist

.website-release-tmpl: &website-release-tmpl
  stage: release
  image: node:$NODE_VERSION
  needs:
    - job: website.build
      artifacts: true
  before_script:
    - pushd website/
    # https://github.com/netlify/cli/issues/1870
    - npm i -g --unsafe-perm netlify-cli
  script:
    - netlify deploy --no-build --site $NETLIFY_SITE_ID --auth $NETLIFY_AUTH_TOKEN --prod --dir=dist/
  environment:
      name: production-website
      url: https://www.hook0.com
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      changes:
        - website/**/*

website.preview:
  stage: release
  image: node:$NODE_VERSION
  needs:
    - job: website.build
      artifacts: true
  before_script:
    - pushd website/
    - npm i -g --unsafe-perm netlify-cli
  script:
    - |
      DEPLOY_OUTPUT=$(netlify deploy --no-build --site $NETLIFY_SITE_ID --auth $NETLIFY_AUTH_TOKEN --dir=dist/ --json)
      DEPLOY_URL=$(echo "$DEPLOY_OUTPUT" | grep -o '"deploy_url":"[^"]*"' | cut -d'"' -f4)
      echo "DEPLOY_URL=$DEPLOY_URL" >> deploy.env
      echo "Preview URL: $DEPLOY_URL"
  artifacts:
    reports:
      dotenv: website/deploy.env
  environment:
    name: preview/$CI_MERGE_REQUEST_IID
    url: $DEPLOY_URL
    on_stop: website.preview.stop
    auto_stop_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - website/**/*

website.preview.stop:
  stage: release
  image: alpine:latest
  script:
    - echo "Preview environment stopped"
  environment:
    name: preview/$CI_MERGE_REQUEST_IID
    action: stop
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - website/**/*
      when: manual

website.release:
  <<: *website-release-tmpl

website.release.manual:
  <<: *website-release-tmpl
  when: manual
