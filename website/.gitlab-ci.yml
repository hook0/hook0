# Website build and deployment to Netlify
# Production: pushes to master branch
# MR Preview: merge request events
# Immutable build: single build artifact used for both production and preview

website.build:
  stage: build
  dependencies: []
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      changes:
        - website/**/*
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - website/**/*
  image: node:$NODE_VERSION
  script:
    - cd website/
    - npm ci
    - npm run build
  cache:
    key: ${CI_COMMIT_REF_SLUG}-website
    paths:
      - .npm
      - website/node_modules/
      - website/.parcel-cache/
  artifacts:
    paths:
      - website/dist
    expire_in: 1 week

# Production deployment to Netlify (master branch)
website.deploy:
  stage: release
  image: node:$NODE_VERSION
  needs:
    - job: website.build
      artifacts: true
  script:
    - npm install -g netlify-cli
    - netlify deploy --dir=website/dist --site="$NETLIFY_WEBSITE_SITE_ID" --auth="$NETLIFY_AUTH_TOKEN" --prod --message="Deploy from $CI_COMMIT_SHORT_SHA"
  environment:
    name: production-website
    url: https://www.hook0.com
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      changes:
        - website/**/*

# Preview deployment to Netlify (MR)
website.deploy.preview:
  stage: release
  image: node:$NODE_VERSION
  needs:
    - job: website.build
      artifacts: true
  script:
    - npm install -g netlify-cli
    - netlify deploy --dir=website/dist --site="$NETLIFY_WEBSITE_SITE_ID" --auth="$NETLIFY_AUTH_TOKEN" --json --message="Preview MR-$CI_MERGE_REQUEST_IID" > deploy_output.json
    - cat deploy_output.json
    - DEPLOY_URL=$(cat deploy_output.json | grep -o '"deploy_url":"[^"]*"' | cut -d'"' -f4)
    - echo "Preview URL - $DEPLOY_URL"
    - echo "DEPLOY_URL=$DEPLOY_URL" >> deploy.env
  artifacts:
    reports:
      dotenv: deploy.env
  environment:
    name: preview/website-$CI_MERGE_REQUEST_IID
    url: $DEPLOY_URL
    auto_stop_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - website/**/*
