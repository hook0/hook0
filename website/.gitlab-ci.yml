# Website build and deployment to hook0/pages/website
# Production: pushes to main branch → GitLab Pages
# MR Preview: pushes to preview/mr-{IID} branch → GitLab Pages

website.build:
  stage: build
  dependencies: []
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      changes:
        - website/**/*
  image: node:$NODE_VERSION
  script:
    - pushd website/
    - npm ci
    - npm run build
  cache:
    key: ${CI_COMMIT_REF_SLUG}-website
    policy: push
    paths:
      - .npm
      - website/node_modules/
      - website/.parcel-cache/
  artifacts:
    paths:
      - website/dist
    expire_in: 1 week

website.build.preview:
  stage: build
  dependencies: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - website/**/*
  image: node:$NODE_VERSION
  script:
    - pushd website/
    - npm ci
    # Build with GitLab Pages URL for the preview branch
    - npx parcel build src/*.ejs --public-url=https://hook0.gitlab.io/pages/website/
  cache:
    key: ${CI_COMMIT_REF_SLUG}-website-preview
    policy: push
    paths:
      - .npm
      - website/node_modules/
      - website/.parcel-cache/
  artifacts:
    paths:
      - website/dist
    expire_in: 1 week

# Production deployment to hook0/pages/website (main branch)
website.deploy:
  stage: release
  image: alpine:3.23
  needs:
    - job: website.build
      artifacts: true
  before_script:
    - apk add --no-cache git
  script:
    - |
      git config --global user.email "bot@hook0.com"
      git config --global user.name "Hook0 Bot"

      git clone --depth 1 "https://oauth2:${PAGES_DEPLOY_TOKEN}@gitlab.com/hook0/pages/website.git" pages-repo
      cd pages-repo

      rm -rf public
      mkdir -p public
      cp -r ../website/dist/* public/

      git add -A
      git commit -m "Deploy website from ${CI_PROJECT_PATH}@${CI_COMMIT_SHORT_SHA}" \
                 -m "Source: ${CI_PIPELINE_URL}" || echo "No changes to commit"
      git push origin main
  environment:
    name: production-website
    url: https://www.hook0.com
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      changes:
        - website/**/*

# Preview deployment to hook0/pages/website (preview branch)
website.deploy.preview:
  stage: release
  image: alpine:3.23
  needs:
    - job: website.build.preview
      artifacts: true
  before_script:
    - apk add --no-cache git
  script:
    - |
      git config --global user.email "bot@hook0.com"
      git config --global user.name "Hook0 Bot"

      TARGET_BRANCH="preview/mr-${CI_MERGE_REQUEST_IID}"

      git clone "https://oauth2:${PAGES_DEPLOY_TOKEN}@gitlab.com/hook0/pages/website.git" pages-repo
      cd pages-repo

      git checkout "$TARGET_BRANCH" 2>/dev/null || git checkout -b "$TARGET_BRANCH"

      rm -rf public
      mkdir -p public
      cp -r ../website/dist/* public/

      git add -A
      git commit -m "Preview website from ${CI_PROJECT_PATH}@${CI_COMMIT_SHORT_SHA}" \
                 -m "MR: ${CI_MERGE_REQUEST_PROJECT_URL}/-/merge_requests/${CI_MERGE_REQUEST_IID}" || echo "No changes to commit"
      git push -u origin "$TARGET_BRANCH" --force
  environment:
    name: preview/website-$CI_MERGE_REQUEST_IID
    url: https://hook0.gitlab.io/pages/website/
    on_stop: website.deploy.preview.stop
    auto_stop_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - website/**/*

website.deploy.preview.stop:
  stage: release
  image: alpine:3.23
  before_script:
    - apk add --no-cache git
  script:
    - |
      git clone --depth 1 "https://oauth2:${PAGES_DEPLOY_TOKEN}@gitlab.com/hook0/pages/website.git" pages-repo || true
      cd pages-repo
      git push origin --delete "preview/mr-${CI_MERGE_REQUEST_IID}" || echo "Branch already deleted"
  environment:
    name: preview/website-$CI_MERGE_REQUEST_IID
    action: stop
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - website/**/*
      when: manual
