variables:
  PG_VERSION: "18"
  RUST_VERSION: "1.92-trixie"
  NODE_VERSION: "24-trixie"
  PROTOC_VERSION: "32.0"
  POSTGRES_DB: hook0-ci
  POSTGRES_USER: runner
  POSTGRES_PASSWORD: ""
  POSTGRES_HOST_AUTH_METHOD: trust



stages:
  - build
  - test
  - release
  - dast
  - documentation

include:
  - template: SAST.gitlab-ci.yml
  - template: DAST.gitlab-ci.yml
  # Container-Scanning disabled: requires Docker DinD, incompatible with Kubernetes runner
  # - template: Jobs/Container-Scanning.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - local: 'api/.gitlab-ci.yml'
  - local: 'clients/rust/.gitlab-ci.yml'
  - local: 'clients/mcp/.gitlab-ci.yml'
  - local: 'clients/typescript/.gitlab-ci.yml'
  - local: 'frontend/.gitlab-ci.yml'
  - local: 'output-worker/.gitlab-ci.yml'
  - local: 'sentry-integration/.gitlab-ci.yml'
  - local: 'website/.gitlab-ci.yml'
  - local: 'e2e-tests/.gitlab-ci.yml'
  - local: 'documentation/.gitlab-ci.yml'

osv_dependency_scan:
  stage: test
  dependencies: []
  image: golang:1.23
  allow_failure: true
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  before_script:
    - go install github.com/google/osv-scanner/cmd/osv-scanner@v1.9.2
  script:
    - osv-scanner --recursive .

dast:
  stage: dast
  dependencies: []
  dast_configuration:
    site_profile: "REST API v1"
    scanner_profile: "DAST"
