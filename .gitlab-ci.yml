workflow:
  rules:
    # Skip branch pipeline for release commits (tag pipeline will run instead)
    - if: $CI_COMMIT_BRANCH && $CI_COMMIT_MESSAGE =~ /^chore\(release\):/
      when: never
    # Run for all other cases
    - when: always

variables:
  PG_VERSION: "18"
  RUST_VERSION: "1.92-trixie"
  NODE_VERSION: "24-trixie"
  PROTOC_VERSION: "32.0"
  POSTGRES_DB: hook0-ci
  POSTGRES_USER: runner
  POSTGRES_PASSWORD: ""
  POSTGRES_HOST_AUTH_METHOD: trust
  GIT_CLIFF_VERSION: "2.11.10"
  CARGO_RELEASE_VERSION: "0.25.18"

stages:
  - build
  - test
  - release
  - trigger-release
  - dast
  - documentation

include:
  - template: SAST.gitlab-ci.yml
  - template: DAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - local: "api/.gitlab-ci.yml"
  - local: "ci/release.gitlab-ci.yml"
  - local: "ci/rust-cache.gitlab-ci.yml"
  - local: "clients/rust/.gitlab-ci.yml"
  - local: "clients/mcp/.gitlab-ci.yml"
  - local: "clients/typescript/.gitlab-ci.yml"
  - local: "documentation/.gitlab-ci.yml"
  - local: "e2e-tests/.gitlab-ci.yml"
  - local: "frontend/.gitlab-ci.yml"
  - local: "output-worker/.gitlab-ci.yml"
  - local: "sentry-integration/.gitlab-ci.yml"
  - local: "website/.gitlab-ci.yml"

osv_dependency_scan:
  stage: test
  dependencies: []
  image: golang:1.25
  allow_failure: true
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  before_script:
    - go install github.com/google/osv-scanner/v2/cmd/osv-scanner@v2.3.0
  script:
    - osv-scanner --recursive .

# Container scanning using Trivy (no Docker required, works on Kubernetes runners)
container_scanning:
  stage: test
  dependencies: []
  image:
    name: aquasec/trivy:0.68.2
    entrypoint: [""]
  allow_failure: true
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  variables:
    TRIVY_NO_PROGRESS: "true"
    TRIVY_CACHE_DIR: ".trivycache/"
  cache:
    paths:
      - .trivycache/
  before_script:
    - trivy --version
  script:
    # Scan all Dockerfiles for misconfigurations
    - trivy config --exit-code 0 --severity HIGH,CRITICAL .
    # Scan filesystem for vulnerabilities in dependencies
    - trivy fs --exit-code 0 --severity HIGH,CRITICAL --scanners vuln .
    # Generate GitLab-compatible report
    - trivy fs --exit-code 0 --format json --output gl-container-scanning-report.json .
  artifacts:
    reports:
      container_scanning: gl-container-scanning-report.json
    paths:
      - gl-container-scanning-report.json
    when: always

dast:
  stage: dast
  dependencies: []
  dast_configuration:
    site_profile: "REST API v1"
    scanner_profile: "DAST"
