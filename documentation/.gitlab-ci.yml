# Documentation build and deployment
# Production: pushes to hook0/pages/documentation (main branch) → GitLab Pages
# MR Preview: uses job artifacts in main repo

documentation.build:
  stage: build
  image: node:${NODE_VERSION}
  cache:
    key: ${CI_COMMIT_REF_SLUG}-docs
    paths:
      - documentation/node_modules/
      - documentation/.npm/
  before_script:
    - cd documentation
    - npm config set cache .npm --global
    - npm ci --prefer-offline --no-audit
  script:
    - npm run build
  artifacts:
    paths:
      - documentation/build/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      changes:
        - documentation/**/*
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - documentation/**/*

# Production deployment to hook0/pages/documentation → GitLab Pages
documentation.deploy:
  stage: release
  image: alpine:3.23
  needs:
    - job: documentation.build
      artifacts: true
  before_script:
    - apk add --no-cache git
  script:
    - |
      git config --global user.email "bot@hook0.com"
      git config --global user.name "Hook0 Bot"

      git clone --depth 1 "https://oauth2:${PAGES_DEPLOY_TOKEN}@gitlab.com/hook0/pages/documentation.git" pages-repo
      cd pages-repo

      rm -rf public
      mkdir -p public
      cp -r ../documentation/build/* public/

      git add -A
      git commit -m "Deploy documentation from ${CI_PROJECT_PATH}@${CI_COMMIT_SHORT_SHA}" \
                 -m "Source: ${CI_PIPELINE_URL}" || echo "No changes to commit"
      git push origin main
  environment:
    name: production-documentation
    url: https://documentation.hook0.com
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      changes:
        - documentation/**/*

# MR Preview using job artifacts (accessible without auth)
documentation.preview:
  stage: release
  image: alpine:3.23
  needs:
    - job: documentation.build
      artifacts: true
  script:
    - mkdir -p public
    - cp -r documentation/build/* public/
  artifacts:
    paths:
      - public
    expose_as: 'Documentation Preview'
    expire_in: 1 week
  environment:
    name: preview/documentation-$CI_MERGE_REQUEST_IID
    url: https://hook0.gitlab.io/-/hook0/-/jobs/$CI_JOB_ID/artifacts/public/index.html
    on_stop: documentation.preview.stop
    auto_stop_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - documentation/**/*

documentation.preview.stop:
  stage: release
  image: alpine:latest
  script:
    - echo "Preview environment stopped"
  environment:
    name: preview/documentation-$CI_MERGE_REQUEST_IID
    action: stop
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - documentation/**/*
      when: manual
