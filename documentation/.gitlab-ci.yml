# Documentation build and deployment to Netlify
# Production: pushes to master branch
# MR Preview: merge request events
# Immutable build: single build artifact used for both production and preview

documentation.build:
  stage: build
  image: node:${NODE_VERSION}
  cache:
    key: ${CI_COMMIT_REF_SLUG}-docs
    paths:
      - documentation/node_modules/
      - documentation/.npm/
  before_script:
    - cd documentation
    - npm config set cache .npm --global
    - npm ci --prefer-offline --no-audit
  script:
    - npm run build
  artifacts:
    paths:
      - documentation/build/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      changes:
        - documentation/**/*
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - documentation/**/*

# Production deployment to Netlify (master branch)
documentation.deploy:
  stage: release
  image: node:${NODE_VERSION}
  needs:
    - job: documentation.build
      artifacts: true
  script:
    - npm install -g netlify-cli
    - netlify deploy --dir=documentation/build --site=$NETLIFY_DOCUMENTATION_SITE_ID --auth=$NETLIFY_AUTH_TOKEN --prod
  environment:
    name: production-documentation
    url: https://documentation.hook0.com
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      changes:
        - documentation/**/*

# Preview deployment to Netlify (MR)
documentation.deploy.preview:
  stage: release
  image: node:${NODE_VERSION}
  needs:
    - job: documentation.build
      artifacts: true
  script:
    - npm install -g netlify-cli
    - |
      DEPLOY_OUTPUT=$(netlify deploy --dir=documentation/build --site=$NETLIFY_DOCUMENTATION_SITE_ID --auth=$NETLIFY_AUTH_TOKEN --json)
      DEPLOY_URL=$(echo "$DEPLOY_OUTPUT" | grep -o '"deploy_ssl_url":"[^"]*"' | cut -d'"' -f4)
      echo "Preview URL: $DEPLOY_URL"
      echo "DEPLOY_URL=$DEPLOY_URL" >> deploy.env
  artifacts:
    reports:
      dotenv: deploy.env
  environment:
    name: preview/documentation-$CI_MERGE_REQUEST_IID
    url: $DEPLOY_URL
    auto_stop_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - documentation/**/*
